<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>اختيار الدبلوم</title>

<style>
  body {
    /* تم إزالة الخلفية والـ padding الزائد من الـ body */
    font-family: "Cairo", sans-serif;
    background: #fff; /* خلفية بيضاء لملء الـ iframe */
    text-align: center;
    padding: 10px; /* هامش بسيط */
    margin: 0;
  }

  /* تم إزالة .dialog-overlay بالكامل لأننا سنعتمد على النافذة الرئيسية */
  
  .dialog-box {
    /* تم تعديل هذا الصندوق ليكون بمثابة محتوى الـ iframe */
    background: #fff;
    border-radius: 10px; 
    padding: 15px;
    box-shadow: none; /* إزالة الظل هنا لأن الـ iframe له ظل خارجي */
    text-align: right;
  }

  .dialog-header {
    font-size: 18px; /* تصغير الخط قليلاً ليلائم الإطار */
    font-weight: 700;
    color: #222;
    text-align: center;
    margin-bottom: 10px; /* إضافة فاصل */
  }

  .toggle-btn {
    background: #2563eb;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 15px;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    transition: all 0.3s ease;
  }

  .toggle-btn:hover {
    background: #1d4ed8;
    transform: scale(1.03);
  }

  .arrow {
    transition: transform 0.3s ease;
  }

  .arrow.rotate {
    transform: rotate(180deg);
  }

  .course-list {
    margin-top: 15px;
    display: none; 
    border-top: 1px solid #ddd;
    padding-top: 10px;
    max-height: 200px; /* تصغير الارتفاع ليلائم الـ iframe */
    overflow-y: auto;   
    padding-right: 5px; 
  }

  .course-item {
    background: #f9fafb;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
  }

  .course-item:hover {
    background: #e0e7ff;
    color: #1e40af;
  }

  .message {
    text-align: center;
    margin-top: 12px;
    color: #16a34a;
    font-weight: 600;
    display: none;
    padding: 10px;
    border: 1px solid #c8e6c9;
    background: #f1fff1;
    border-radius: 8px;
  }

  .levies-text-red {
    color: #ef4444; 
    font-weight: 700;
    font-size: 15px;
    background: #fee2e2; 
    padding: 3px 8px;
    border-radius: 6px;
  }


  /* تم إزالة زر الإغلاق من هنا لأنه سيتم استخدامه في الصفحة الرئيسية */
  .close-btn { 
    display: none !important; 
  }

  /* تم إزالة حركات الـ CSS لأن الـ iframe قد لا يدعمها بشكل كامل */

</style>
</head>

<body>

<div class="dialog-box">
  <div class="dialog-header">🎓اختر الدورة المراد التسوق لها </div>
  <button class="toggle-btn" id="toggleButton">
    عرض الدورات <span class="arrow" id="arrow">🔻</span>
  </button>

  <div class="course-list" id="courseList">
    </div>

  <div class="message" id="message">تم نسخ الرابط ✅</div>
  </div>


<script>
// ⛔⛔⛔ هام: تم تحديث هذا بالرابط الجديد بعد نشر Google Apps Script ⛔⛔⛔
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvaDty4OhXdnR3poYEuwj9W53esn2923XYpKZc7LTKf_M17Z576YGP_EkjB9bt-hN8pA/exec";

let COURSES = []; 
let marketerId = 'TTTTTT11'; // تم تعيين قيمة افتراضية هنا

// ====== الدوال الأساسية ======

/**
 * 1. استخلاص معرّف المسوِّق من رابط URL الحالي (الآن يبحث في رابط الـ iframe)
 * @returns {string} معرّف المسوِّق أو القيمة الافتراضية TTTTTT11
 */
function getMarketerIdFromUrl() {
    const fallbackId = 'TTTTTT11';
    // نستخدم window.parent.location.search للبحث في رابط الصفحة الأم
    try {
        const parentUrlParams = new URLSearchParams(window.parent.location.search);
        // نبحث عن marketer_id في رابط الصفحة الرئيسية
        return parentUrlParams.get('marketer_id') || parentUrlParams.get('id') || fallbackId;
    } catch(e) {
        // في حال كان الـ iframe محمل من نطاق آخر (Cross-origin)، نعود للافتراضي
        console.warn("Could not access parent URL for marketer ID, using fallback.");
        return fallbackId;
    }
}


/**
 * 2. دالة لجلب الدورات من Google Sheets API
 */
async function fetchCourses() {
    const listContainer = document.getElementById('courseList');
    listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color:#555;">جارٍ تحميل الدورات...</div>';
    // ليتم التحكم بالعرض بواسطة toggleList
    
    try {
        const response = await fetch(APP_SCRIPT_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (data && data.courses && Array.isArray(data.courses)) {
            COURSES = data.courses; 
            renderCourseList(); 
        } else {
            throw new Error("تنسيق بيانات غير صالح من الخادم.");
        }
    } catch (error) {
        console.error("Error fetching courses:", error);
        listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color:#ef4444;">❌ فشل تحميل الدورات. تحقق من رابط Apps Script.</div>';
    }
}


/**
 * 3. بناء وإضافة عناصر الدورات إلى قائمة القائمة
 */
function renderCourseList() {
    const listContainer = document.getElementById('courseList');
    listContainer.innerHTML = ''; 

    if (COURSES.length === 0) {
         listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color:#555;">لا توجد دورات متاحة حالياً.</div>';
         return;
    }

    COURSES.forEach(course => {
        const item = document.createElement('div');
        item.className = 'course-item';
        
        item.innerHTML = `
          <span>${course.name}</span>
          <span class="levies-text-red">الرسوم: ${course.levies} $</span>
        `;
        
        item.setAttribute('onclick', `copyLink('${course.slug}')`); 
        listContainer.appendChild(item);
    });
}

/**
 * 4. تبديل حالة عرض وإخفاء قائمة الدورات
 */
function toggleList() {
    const list = document.getElementById('courseList');
    const arrow = document.getElementById('arrow');
    const isVisible = list.style.display === 'block';
    
    list.style.display = isVisible ? 'none' : 'block';
    arrow.classList.toggle('rotate');

    if (!isVisible && COURSES.length === 0) {
        fetchCourses();
    }
    
    // محاولة إرسال رسالة إلى الصفحة الأم لتعديل ارتفاع الدايلوج
    try {
        window.parent.postMessage({ type: 'DIALOG_RESIZE', height: document.body.scrollHeight + 50 }, '*');
    } catch(e) {
        // نتجاهل الخطأ إذا لم نتمكن من الوصول للصفحة الأم
    }
}


/**
 * 5. الدالة المعدلة لنسخ الرابط مع إضافة معرّف المسوِّق
 */
function copyLink(courseSlug) {
    const baseUrl = "https://skillia.netlify.app/course.html"; 
    let fullLink = baseUrl + "?id=" + courseSlug;
    fullLink += "&marketer_id=" + marketerId;
    
    navigator.clipboard.writeText(fullLink).then(() => {
        const msg = document.getElementById('message');
        msg.style.display = 'block';
        msg.innerHTML = `تم نسخ رابط الدورة <span style="font-weight: bold; color: #1d4ed8;">${courseSlug.toUpperCase()}</span> بنجاح!<br> تم إضافة كودك: <span style="font-weight: bold;">${marketerId}</span> ✅`;
        setTimeout(() => msg.style.display = 'none', 3000);
    });
}


/**
 * 6. دالة التهيئة الرئيسية التي يتم استدعاؤها عند تحميل الصفحة
 */
function initializeDialog() {
    // 1. استخلاص كود المسوِّق مرة واحدة
    marketerId = getMarketerIdFromUrl();
    
    // 2. تحديث رأس الدايلوج لعرض كود المسوِّق
    const header = document.querySelector('.dialog-header');
    header.innerHTML = `🎓اختر الدورة المراد التسوق لها (كودك: <span style="color:#2563eb;">${marketerId}</span>)`;
    
    // 3. ربط زر التبديل (عند الضغط عليه لأول مرة، سيقوم بتحميل الدورات)
    document.getElementById('toggleButton').addEventListener('click', toggleList);
}


// عند تحميل الصفحة، يتم استدعاء دالة التهيئة
window.onload = initializeDialog; 
</script>

</body>
</html>

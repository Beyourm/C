<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إعادة تعيين كلمة المرور - مؤسسة "كن أنت"</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <link rel="stylesheet" href="../assets/fonts/tajawal.css"> 
  
  <style>
    /* ---------------------------------------------------------------------- */
    /* **أنماط CSS (مستوحاة من التصميم الأصلي)** */
    /* ---------------------------------------------------------------------- */
    :root {
      --primary-color: #0d3b14;
      --secondary-color: #e5a72d;
      --accent-color: #f7f3e9;
      --text-color-dark: #2d3748;
      --muted-color: #4a5568;
      --white-color: #ffffff;
      --border-radius-lg: 20px;
    }

    /* توحيد Box-Sizing للجميع للتجاوبية */
    *, *::before, *::after {
        box-sizing: border-box;
        font-family: "Tajawal", sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f0f4f9 0%, #e8eef5 100%); 
      margin: 0; 
      padding: 20px;
      display: flex; 
      justify-content: center; 
      align-items: center;
      min-height: 100vh; 
      color: var(--text-color-dark);
    }

    .container {
      max-width: 500px; /* أصغر قليلاً لصفحة إعادة التعيين */
      width: 95%; 
      margin: auto;
    }

    .card {
      background: var(--white-color);
      border-radius: var(--border-radius-lg);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    header {
      background: var(--primary-color);
      color: #fff;
      padding: 30px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 900;
    }

    .content {
      padding: 30px;
    }

    /* أنماط النموذج */
    .row {
      display: flex;
      flex-wrap: wrap; 
      gap: 15px;
      margin-bottom: 15px;
    }

    .col {
      flex: 1 1 100%; /* عمود واحد في هذه الصفحة */
      position: relative;
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--muted-color);
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 12px;
      border: 1px solid #e6eef8;
      background: #fff;
      font-size: 15px;
      transition: border-color 0.3s, background-color 0.3s;
    }

    input:focus {
      border-color: var(--primary-color);
      background-color: var(--accent-color);
      outline: none;
      box-shadow: none;
    }

    .input-wrapper {
        position: relative;
    }
    
    /* ضبط مساحة الأيقونات */
    input[type="email"], input[type="text"] {
        padding-right: 40px; 
    }
    input[type="password"] {
        padding-right: 40px; 
        padding-left: 40px; 
    }

    .decorator-icon {
        position: absolute;
        top: 50%;
        right: 12px;
        transform: translateY(-50%);
        color: var(--muted-color);
        font-size: 16px;
        pointer-events: none;
        z-index: 5;
    }

    .toggle-password {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: var(--muted-color);
        z-index: 10;
        transition: color 0.2s;
    }

    /* أنماط الأزرار */
    button {
      cursor: pointer;
      border: 0;
      font-weight: 700;
      transition: all 0.3s ease;
      padding: 12px 20px;
      border-radius: 12px;
      width: 100%; /* الأزرار تأخذ عرض كامل هنا */
    }

    .btn-accept {
      background: linear-gradient(135deg, #1a5c24, #0d3b14);
      color: var(--white-color);
      box-shadow: 0 4px 12px rgba(13, 59, 20, 0.3);
    }
    
    .btn-accept:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 15px rgba(0,0,0,0.15); 
    }

    /* الرسائل */
    .success, .error { 
        display: none; padding:18px; border-radius:10px; margin-top:15px; font-weight:bold; line-height:1.5; 
        align-items: center; gap: 10px; opacity: 0; transition: opacity 0.5s ease;
    }
    .success { background:#d4edda; color:#155724; border: 1px solid #c3e6cb; }
    .error { background: #fce4e4; color: #b71c1c; border: 1px solid #f8c1c1; font-weight:500; }
    .success.show, .error.show { opacity: 1; display:flex; }
    
    /* الأزرار المعطلة والتحميل */
    .fa-spin {
        display: inline-block;
        animation: fa-spin 1s infinite linear;
        margin-left: 5px;
    }
    @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* التجاوبية */
    @media (max-width: 550px) {
        .content { padding: 20px; }
        header h1 { font-size: 20px; }
        .btn-accept { padding: 14px; font-size: 16px; }
    }
  </style>

</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>إعادة تعيين كلمة المرور</h1>
      </header>
      <div class="content">
          
          <div class="note" style="margin-bottom: 20px;">
              الرجاء إدخال بريدك الإلكتروني لتلقي رمز تحقق لإعادة تعيين كلمة المرور.
          </div>

        <form id="requestResetForm">
          <h3>الخطوة 1: طلب الرمز</h3>
          <div class="row">
            <div class="col">
              <label for="resetEmail">البريد الإلكتروني</label>
              <div class="input-wrapper">
                <i class="fa-solid fa-envelope decorator-icon"></i> 
                <input id="resetEmail" name="email" type="email" placeholder="name@example.com" required />
              </div>
            </div>
          </div>
          
          <div class="actions">
              <button type="submit" class="btn-accept" id="requestSubmitBtn">إرسال رمز التحقق</button>
          </div>
          <div class="error" id="requestErrorBox"><i class="fa-solid fa-circle-exclamation"></i> <span></span></div>
          <div class="success" id="requestSuccessBox"><i class="fa-solid fa-circle-check"></i> <span></span></div>
        </form>

        <form id="resetPasswordForm" style="display: none;">
            <h3 style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">الخطوة 2: إعادة التعيين</h3>
            
            <div class="row">
                <div class="col">
                    <label for="otpCode">رمز التحقق (OTP)</label>
                    <div class="input-wrapper">
                        <i class="fa-solid fa-key decorator-icon"></i> 
                        <input id="otpCode" name="otpCode" type="text" placeholder="أدخل الرمز المكون من 6 أرقام" pattern="[0-9]{6}" maxlength="6" required />
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label for="newPassword">كلمة المرور الجديدة</label>
                    <div class="input-wrapper">
                        <i class="fa-solid fa-lock decorator-icon"></i> 
                        <input id="newPassword" name="newPassword" type="password" required />
                        <i class="fa-solid fa-eye toggle-password" data-target="newPassword" aria-label="إظهار كلمة المرور"></i> 
                    </div>
                </div>
                <div class="col">
                    <label for="confirmNewPassword">تأكيد كلمة المرور الجديدة</label>
                    <div class="input-wrapper">
                        <i class="fa-solid fa-lock decorator-icon"></i> 
                        <input id="confirmNewPassword" name="confirmNewPassword" type="password" required />
                        <i class="fa-solid fa-eye toggle-password" data-target="confirmNewPassword" aria-label="إظهار كلمة المرور"></i> 
                    </div>
                </div>
            </div>

            <div class="actions">
                <button type="submit" class="btn-accept" id="resetSubmitBtn">إعادة تعيين كلمة المرور</button>
            </div>
            <div class="error" id="resetErrorBox"><i class="fa-solid fa-circle-exclamation"></i> <span></span></div>
        </form>
        
        <p class="note" style="text-align: center; margin-top: 25px; padding-top: 10px; border-top: 1px dashed #eee;">
            <a href="index.html" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">العودة لصفحة تسجيل الدخول</a>
        </p>

      </div>
    </div>
  </div>
      <script src="url.js"></script>   
  <script>
    // ----------------------------------------------------------------------
    // الدوال الأساسية (من الكود الأصلي)
    // ----------------------------------------------------------------------
    // يجب استبدال هذا برابط Apps Script الفعلي الخاص بك






    
    function setLoadingState(buttonElement, loadingText = 'جاري الإرسال...') {
        if (!buttonElement.dataset.originalText) {
            buttonElement.dataset.originalText = buttonElement.innerHTML;
        }
        buttonElement.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${loadingText}`;
        buttonElement.disabled = true;
    }

    function resetButton(buttonElement) {
        buttonElement.innerHTML = buttonElement.dataset.originalText || 'إرسال';
        buttonElement.disabled = false;
    }

    function showMessage(box, text, duration = 3000) {
        const messageElement = box.querySelector('span') || box;
        messageElement.textContent = text;
        box.classList.add('show');
        setTimeout(() => { box.classList.remove('show'); }, duration);
    }

    async function sendDataToScript(action, formData) {
        // يتم إرسال بيانات البريد الإلكتروني في كلتا الخطوتين
        const payload = { action, ...formData };
        
        try {
            const response = await fetch(URL_LONG, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                body: JSON.stringify(payload)
            });

            const text = await response.text();
            const result = JSON.parse(text);

            return result;
        } catch (error) {
            console.error('Fetch Error:', error);
            return { success: false, message: "فشل الاتصال بالخادم. تحقق من الرابط أو اتصالك بالشبكة." };
        }
    }

    // وظيفة تبديل عرض كلمة المرور
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const targetInput = document.getElementById(targetId);
            const isPassword = targetInput.type === 'password';
            targetInput.type = isPassword ? 'text' : 'password';
            this.classList.toggle('fa-eye', isPassword);
            this.classList.toggle('fa-eye-slash', !isPassword);
        });
    });

    // ----------------------------------------------------------------------
    // معالجة الخطوة 1: طلب الرمز عبر البريد الإلكتروني
    // ----------------------------------------------------------------------
    const requestResetForm = document.getElementById('requestResetForm');
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const requestSubmitBtn = document.getElementById('requestSubmitBtn');
    const requestErrorBox = document.getElementById('requestErrorBox');
    const requestSuccessBox = document.getElementById('requestSuccessBox');
    
    let pendingEmail = ''; // لتخزين الإيميل بعد الخطوة 1

    requestResetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('resetEmail').value.trim();
        pendingEmail = email; // تخزين الإيميل لاستخدامه في الخطوة 2

        setLoadingState(requestSubmitBtn, 'جاري الإرسال...');
        requestErrorBox.classList.remove('show');
        requestSuccessBox.classList.remove('show');

        const formData = { email: email };
        // نستخدم الإجراء "request_reset" في Apps Script
// الخطوة 1: طلب الرمز عبر البريد الإلكتروني
const result = await sendDataToScript('forgot_password', formData); 


        resetButton(requestSubmitBtn);

        if (result.success) {
            showMessage(requestSuccessBox, result.message, 5000);
            
            // إخفاء الخطوة 1 وإظهار الخطوة 2
            requestResetForm.style.display = 'none';
            resetPasswordForm.style.display = 'block';

        } else {
            showMessage(requestErrorBox, result.message);
        }
    });


    // ----------------------------------------------------------------------
    // معالجة الخطوة 2: التحقق من الرمز وإعادة تعيين كلمة المرور
    // ----------------------------------------------------------------------
    const resetSubmitBtn = document.getElementById('resetSubmitBtn');
    const resetErrorBox = document.getElementById('resetErrorBox');

    resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const otpCode = document.getElementById('otpCode').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();
        
        resetErrorBox.classList.remove('show');

        if (newPassword !== confirmNewPassword) {
            showMessage(resetErrorBox, 'كلمتا المرور الجديدتان غير متطابقتين.');
            return;
        }

        if (!pendingEmail) {
             showMessage(resetErrorBox, 'خطأ: لم يتم تحديد البريد الإلكتروني.');
             return;
        }

        setLoadingState(resetSubmitBtn, 'جاري إعادة التعيين...');

        const formData = { 
            email: pendingEmail, // استخدام الإيميل المخزن
            otp: otpCode,
            password: newPassword
        };
        
        // نستخدم الإجراء "reset_password" في Apps Script
        const result = await sendDataToScript('reset_password', formData); 

        resetButton(resetSubmitBtn);

        if (result.success) {
            showMessage(requestSuccessBox, result.message, 5000); 
            
            // مسح الحقول وإعادة التوجيه لصفحة تسجيل الدخول
            setTimeout(() => {
                 window.location.href = "index.html"; // افترض أن صفحة الدخول هي index.html
            }, 3000);

        } else {
            showMessage(resetErrorBox, result.message);
        }
    });
  </script>
</body>
</html>
